<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR Scanner Mobile App</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qr-scanner/1.4.2/qr-scanner.umd.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 50%, #000000 100%);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .app-container { max-width: 100vw; margin: 0 auto; padding: 10px; }
        .header { text-align: center; padding: 20px 10px; background: linear-gradient(135deg, #dc143c, #b71c1c); border-radius: 0 0 20px 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(220, 20, 60, 0.3); }
        .header h1 { font-size: 24px; margin-bottom: 5px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        .header p { font-size: 14px; opacity: 0.9; }
        .camera-container { position: relative; width: 100%; max-width: 400px; margin: 0 auto 20px; border-radius: 15px; overflow: hidden; box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
        #video-container { position: relative; width: 100%; height: 300px; background: #2a2a2a; border-radius: 15px; overflow: hidden; }
        #qr-video { width: 100%; height: 100%; object-fit: cover; display: none; }
        .camera-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 200px; height: 200px; border: 3px solid #dc143c; border-radius: 15px; box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.3); pointer-events: none; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { border-color: #dc143c; } 50% { border-color: #ff4569; } }
        .camera-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 300px; background: #2a2a2a; border: 3px dashed #dc143c; border-radius: 15px; text-align: center; }
        .camera-icon { font-size: 48px; color: #dc143c; margin-bottom: 15px; }
        .controls { display: flex; justify-content: center; gap: 10px; margin: 20px 0; flex-wrap: wrap; }
        .btn { background: linear-gradient(135deg, #dc143c, #b71c1c); color: white; border: none; padding: 12px 20px; border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; min-width: 120px; box-shadow: 0 4px 15px rgba(220, 20, 60, 0.3); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(220, 20, 60, 0.4); }
        .btn:disabled { background: #666; cursor: not-allowed; }
        .qr-details { background: linear-gradient(135deg, #2a2a2a, #1a1a1a); border: 2px solid #dc143c; border-radius: 15px; padding: 20px; margin: 20px 0; box-shadow: 0 4px 15px rgba(220, 20, 60, 0.2); display: none; }
        .qr-details h3 { color: #dc143c; margin-bottom: 15px; text-align: center; font-size: 20px; }
        .detail-item { background: #333; padding: 10px 15px; margin: 8px 0; border-radius: 8px; border-left: 4px solid #dc143c; word-wrap: break-word; }
        .detail-item strong { color: #dc143c; display: block; margin-bottom: 5px; }
        .action-buttons { display: none; gap: 15px; margin: 20px 0; }
        .action-btn { flex: 1; padding: 15px; font-size: 18px; border-radius: 15px; border: none; font-weight: bold; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .checkin-btn { background: linear-gradient(135deg, #2e7d32, #1b5e20); color: white; }
        .checkout-btn { background: linear-gradient(135deg, #d32f2f, #b71c1c); color: white; }
        .success-msg, .error-msg { padding: 15px; border-radius: 10px; margin: 15px 0; text-align: center; font-weight: bold; display: none; }
        .success-msg { background: #2e7d32; border: 2px solid #4caf50; }
        .error-msg { background: #d32f2f; border: 2px solid #f44336; }
        .history { background: #2a2a2a; border-radius: 15px; padding: 20px; margin: 20px 0; max-height: 300px; overflow-y: auto; }
        .history h3 { color: #dc143c; margin-bottom: 15px; text-align: center; }
        .history-item { background: #333; padding: 10px; margin: 8px 0; border-radius: 8px; border-left: 4px solid #dc143c; font-size: 14px; }
        .loading { display: none; text-align: center; color: #dc143c; margin: 20px 0; }
        .spinner { border: 3px solid #333; border-top: 3px solid #dc143c; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 768px) { .controls { flex-direction: column; } .btn { width: 200px; } .action-buttons { flex-direction: column; } }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>ðŸ“± QR Scanner</h1>
            <p>Mobile-Optimized QR Code Scanner</p>
        </div>

        <div class="camera-container">
            <div id="video-container">
                <video id="qr-video" playsinline></video>
                <div class="camera-overlay"></div>
                <div class="camera-placeholder" id="camera-placeholder">
                    <div class="camera-icon">ðŸ“¸</div>
                    <p>Tap "Start Camera" to begin scanning</p>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="btn" id="start-btn" onclick="startCamera()">Start Camera</button>
            <button class="btn" id="stop-btn" onclick="stopCamera()" disabled>Stop Camera</button>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Processing QR Code...</p>
        </div>

        <div class="success-msg" id="success-msg"></div>
        <div class="error-msg" id="error-msg"></div>

        <div class="qr-details" id="qr-details">
            <h3>ðŸ“‹ QR Code Details</h3>
            <div id="details-content"></div>
        </div>

        <div class="action-buttons" id="action-buttons">
            <button class="action-btn checkin-btn" onclick="checkIn()">ðŸŸ¢ CHECK IN</button>
            <button class="action-btn checkout-btn" onclick="checkOut()">ðŸ”´ CHECK OUT</button>
        </div>

        <div class="history">
            <h3>ðŸ“ˆ Recent Activity</h3>
            <div id="history-content"><p style="text-align: center; opacity: 0.7;">No scans yet</p></div>
        </div>
    </div>

    <script>
        let qrScanner = null;
        let currentQRData = null;
        let scanHistory = JSON.parse(localStorage.getItem('qrScanHistory') || '[]');

        // ðŸ”¹ Supabase configuration (replace with your own project details)
        const SUPABASE_URL = "https://bsgtvopnvxuwqvvjkkxy.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJzZ3R2b3Budnh1d3F2dmpra3h5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNjE4ODMsImV4cCI6MjA3MzkzNzg4M30.0DXHWwEII9nulWrUzJeY_DgVBgZNNxgd1rifg-jG0ys";
        const supabase = supabasejs.createClient(SUPABASE_URL, SUPABASE_KEY);

        function showMessage(message, isError = false) {
            const successMsg = document.getElementById('success-msg');
            const errorMsg = document.getElementById('error-msg');
            if (isError) {
                errorMsg.textContent = message; errorMsg.style.display = 'block';
                successMsg.style.display = 'none'; setTimeout(() => errorMsg.style.display = 'none', 3000);
            } else {
                successMsg.textContent = message; successMsg.style.display = 'block';
                errorMsg.style.display = 'none'; setTimeout(() => successMsg.style.display = 'none', 3000);
            }
        }
        function showLoading(show) { document.getElementById('loading').style.display = show ? 'block' : 'none'; }

        async function startCamera() {
            try {
                showLoading(true);
                const video = document.getElementById('qr-video');
                const placeholder = document.getElementById('camera-placeholder');
                if (!QrScanner.hasCamera()) throw new Error('No camera found');
                qrScanner = new QrScanner(video, result => handleQRResult(result.data), { preferredCamera: 'environment' });
                await qrScanner.start();
                video.style.display = 'block'; placeholder.style.display = 'none';
                document.getElementById('start-btn').disabled = true;
                document.getElementById('stop-btn').disabled = false;
                showLoading(false); showMessage('Camera started successfully! Point at a QR code to scan.');
            } catch (error) {
                showLoading(false); showMessage(`Camera error: ${error.message}`, true);
            }
        }

        function stopCamera() {
            if (qrScanner) { qrScanner.stop(); qrScanner.destroy(); qrScanner = null; }
            document.getElementById('qr-video').style.display = 'none';
            document.getElementById('camera-placeholder').style.display = 'flex';
            document.getElementById('start-btn').disabled = false;
            document.getElementById('stop-btn').disabled = true;
            showMessage('Camera stopped');
        }

        function handleQRResult(data) {
            showLoading(true);
            try {
                currentQRData = parseQRData(data);
                displayQRDetails(currentQRData);
                saveToHistory('QR_SCANNED', currentQRData);
                showLoading(false); showMessage('QR Code scanned successfully!');
                stopCamera();
            } catch (error) {
                showLoading(false); showMessage(`Error processing QR: ${error.message}`, true);
            }
        }

        function parseQRData(data) {
            try { return JSON.parse(data); }
            catch {
                if (data.includes('\n') || data.includes(';')) {
                    const separator = data.includes('\n') ? '\n' : ';'; const lines = data.split(separator); const parsed = {};
                    lines.forEach(line => {
                        if (line.includes(':')) { const [k, v] = line.split(':', 2); parsed[k.trim()] = v.trim(); }
                        else if (line.includes('=')) { const [k, v] = line.split('=', 2); parsed[k.trim()] = v.trim(); }
                    });
                    return Object.keys(parsed).length > 0 ? parsed : { raw_data: data };
                } else return { raw_data: data };
            }
        }

        function displayQRDetails(data) {
            const detailsDiv = document.getElementById('qr-details');
            const contentDiv = document.getElementById('details-content');
            const actionButtons = document.getElementById('action-buttons');
            contentDiv.innerHTML = '';
            Object.entries(data).forEach(([k, v]) => {
                const item = document.createElement('div'); item.className = 'detail-item';
                item.innerHTML = `<strong>${k.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</strong> ${v}`;
                contentDiv.appendChild(item);
            });
            detailsDiv.style.display = 'block'; actionButtons.style.display = 'flex';
        }

        function checkIn() {
            if (!currentQRData) return;
            const timestamp = new Date().toISOString();
            saveToHistory('CHECK_IN', currentQRData);
            saveToSupabase('CHECK_IN', currentQRData, timestamp);
            showMessage('âœ… Check-in recorded successfully!'); updateHistoryDisplay();
        }

        function checkOut() {
            if (!currentQRData) return;
            const timestamp = new Date().toISOString();
            saveToHistory('CHECK_OUT', currentQRData);
            saveToSupabase('CHECK_OUT', currentQRData, timestamp);
            showMessage('âœ… Check-out recorded successfully!'); updateHistoryDisplay();
        }

        function saveToHistory(action, qrData) {
            const record = { id: Date.now(), action, qrData, timestamp: new Date().toISOString(), date: new Date().toLocaleString() };
            scanHistory.unshift(record); scanHistory = scanHistory.slice(0, 20);
            localStorage.setItem('qrScanHistory', JSON.stringify(scanHistory)); updateHistoryDisplay();
        }

        async function saveToSupabase(action, qrData, timestamp) {
            try {
                const { data, error } = await supabase.from("qr_scans").insert([
                    { action, qr_data: qrData, timestamp, created_at: new Date().toISOString() }
                ]);
                if (error) console.error("Supabase save error:", error.message);
                else console.log("Saved to Supabase:", data);
            } catch (err) { console.error("Unexpected error saving:", err); }
        }

        function updateHistoryDisplay() {
            const historyContent = document.getElementById('history-content');
            if (scanHistory.length === 0) { historyContent.innerHTML = '<p style="text-align: center; opacity: 0.7;">No scans yet</p>'; return; }
            historyContent.innerHTML = scanHistory.slice(0, 5).map(r => `
                <div class="history-item">
                    <strong>${r.action}</strong><br>
                    <small>${r.date}</small><br>
                    <span style="opacity: 0.8;">${r.qrData.raw_data || Object.values(r.qrData).join(', ').substring(0, 50) + '...'}</span>
                </div>`).join('');
        }

        document.addEventListener('DOMContentLoaded', () => { updateHistoryDisplay(); if (location.protocol !== 'https:' && location.hostname !== 'localhost') { showMessage('Camera requires HTTPS', true); } });
        document.addEventListener('visibilitychange', () => { if (document.hidden && qrScanner) stopCamera(); });
    </script>
</body>
</html>
